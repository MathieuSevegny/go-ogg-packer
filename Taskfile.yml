version: "3"

dotenv: ['.env']

env:
  BASE_IMAGE: go-ogg-packer:base

tasks:
  install-mac-deps:
    desc: Install external dependencies for macOS
    cmds:
      - brew install opus

  install-linux-deps:
    desc: Install external dependencies for Linux
    cmds:
      - apt-get update && apt-get install libopus-dev

  pretty:
    desc: Prettify code
    cmds:
      - golangci-lint fmt

  lint:
    desc: Run linters
    cmds:
      - golangci-lint run

  test:
    desc: Run tests
    cmds:
      - go test -v -shuffle=on -cover -race ./...

  docker-build:
    desc: Build docker image
    cmds:
      - docker build --platform=linux/amd64 -t {{.BASE_IMAGE}} -f Dockerfile .

  docker-test:
    desc: Run tests in docker
    cmds:
      - docker run {{.BASE_IMAGE}} task test
